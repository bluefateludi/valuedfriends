# 微信云托管部署指南

## 📋 部署前准备清单

### 1. 账号准备
- [ ] 微信开发者账号
- [ ] 微信云托管服务开通
- [ ] 实名认证完成

### 2. 数据库准备
- [ ] MySQL数据库实例（推荐使用腾讯云MySQL）
- [ ] Redis实例（您已完成 ✅）
- [ ] 数据库表结构初始化

### 3. 代码准备
- [ ] Dockerfile优化完成 ✅
- [ ] 生产环境配置更新完成 ✅
- [ ] 代码推送到Git仓库

## 🚀 部署步骤

### 步骤1：登录微信云托管控制台
1. 访问 [微信云托管控制台](https://cloud.weixin.qq.com/)
2. 使用微信开发者账号登录
3. 选择或创建小程序/公众号

### 步骤2：创建云托管服务
1. 进入"云托管"页面
2. 点击"新建服务"
3. 填写服务信息：
   - 服务名称：`valuedfriends`
   - 服务描述：`基于标签的智能推荐系统`
   - 地域：选择就近地域

### 步骤3：配置环境变量
在云托管控制台的"环境变量"页面添加以下配置：

#### 数据库配置
```
DB_URL=jdbc:mysql://your-mysql-host:3306/valuesfriends?useSSL=true&serverTimezone=Asia/Shanghai&characterEncoding=utf8
DB_USERNAME=root
DB_PASSWORD=@Value1234
```

#### Redis配置
```
REDIS_HOST=your-redis-host
REDIS_PORT=6379
REDIS_DATABASE=1
REDIS_PASSWORD=your-redis-password
```

#### 其他配置（可选）
```
SPRING_PROFILES_ACTIVE=prod
JAVA_OPTS=-Xms256m -Xmx512m -XX:+UseG1GC
```

### 步骤4：配置代码仓库
1. 在"版本管理"页面关联Git仓库
2. 选择分支（建议使用main或master）
3. 设置构建路径为根目录 `/`

### 步骤5：配置构建设置
1. 构建方式：选择"Dockerfile"
2. Dockerfile路径：`./Dockerfile`
3. 构建上下文：`.`

### 步骤6：配置服务设置
1. **端口配置**：80（与Dockerfile中EXPOSE保持一致）
2. **CPU配置**：0.25核（可根据需要调整）
3. **内存配置**：0.5GB（可根据需要调整）
4. **实例数量**：1个（可根据流量调整）

### 步骤7：部署发布
1. 点击"发布版本"
2. 填写版本说明
3. 确认配置无误后点击"发布"
4. 等待构建和部署完成

## 🔧 数据库配置详细说明

### MySQL数据库配置
如果您还没有MySQL数据库，推荐使用腾讯云MySQL：

1. **购买腾讯云MySQL实例**
   - 登录腾讯云控制台
   - 选择云数据库MySQL
   - 购买实例（建议选择与云托管相同地域）

2. **获取连接信息**
   ```
   主机地址：cdb-xxx.tencentcdb.com
   端口：3306
   用户名：root
   密码：您设置的密码
   ```

3. **创建数据库**
   ```sql
   CREATE DATABASE valuesfriends CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   ```

4. **导入表结构**
   - 执行项目中的 `sql/create_table.sql`
   - 可选：执行 `sql/insert_test_data.sql` 导入测试数据

### Redis配置
您已经配置了Redis ✅，确保：
- Redis服务正常运行
- 网络连通性正常
- 如果设置了密码，记得在环境变量中配置

## 🌐 域名和访问配置

### 1. 获取默认域名
部署成功后，微信云托管会提供一个默认域名：
```
https://your-service-xxx.tcb.qcloud.la
```

### 2. 配置自定义域名（可选）
1. 在云托管控制台的"域名管理"页面
2. 添加自定义域名
3. 配置DNS解析
4. 申请SSL证书

### 3. 接口文档访问
部署成功后，可通过以下地址访问接口文档：
```
https://your-domain/api/doc.html
```

## 📊 监控和日志

### 1. 查看部署状态
- 在云托管控制台查看服务状态
- 检查实例运行情况
- 查看资源使用情况

### 2. 查看应用日志
- 在"日志"页面查看应用输出
- 监控错误日志
- 分析性能指标

### 3. 健康检查
配置健康检查路径（可选）：
```
路径：/api/health
端口：80
```

## ⚠️ 注意事项

### 1. 安全配置
- 数据库密码使用强密码
- Redis设置访问密码
- 定期更新依赖包版本

### 2. 性能优化
- 根据实际流量调整实例规格
- 配置合适的JVM参数
- 使用连接池优化数据库连接

### 3. 成本控制
- 监控资源使用情况
- 合理配置自动扩缩容
- 定期清理无用的版本

### 4. 备份策略
- 定期备份数据库
- 保存重要配置文件
- 建立代码版本管理

## 🔍 常见问题排查

### 1. 部署失败
- 检查Dockerfile语法
- 确认依赖包是否正确
- 查看构建日志

### 2. 启动失败
- 检查环境变量配置
- 确认数据库连接
- 查看应用日志

### 3. 访问异常
- 检查端口配置
- 确认域名解析
- 查看网络连通性

## 📞 技术支持

如遇到问题，可以：
1. 查看微信云托管官方文档
2. 在微信开放社区提问
3. 联系腾讯云技术支持

---

**部署完成后，您的智能推荐系统就可以在微信云托管上稳定运行了！** 🎉