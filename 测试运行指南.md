# 测试运行指南

## 测试文件说明

项目包含以下测试文件：

1. **MatchServiceImplTest.java** - 匹配服务单元测试
2. **UserControllerMatchTest.java** - 用户匹配控制器集成测试
3. **MatchServicePerformanceTest.java** - 匹配服务性能测试

## 运行测试的方法

### 方法一：使用 Maven 命令行

#### 运行所有测试
```bash
cd "d:\Program code\java\valuedfriends"
mvn test
```

#### 运行特定测试类
```bash
# 运行 MatchServiceImplTest
mvn test -Dtest=MatchServiceImplTest

# 运行 UserControllerMatchTest
mvn test -Dtest=UserControllerMatchTest

# 运行 MatchServicePerformanceTest
mvn test -Dtest=MatchServicePerformanceTest
```

#### 运行特定测试方法
```bash
# 运行 MatchServiceImplTest 中的特定方法
mvn test -Dtest=MatchServiceImplTest#testBatchMatchUsers_Success
```

### 方法二：使用 IDE（推荐）

#### IntelliJ IDEA
1. 打开项目：`d:\Program code\java\valuedfriends`
2. 导航到测试文件：`src/test/java/com/yupi/springbootinit/service/impl/MatchServiceImplTest.java`
3. 右键点击类名或方法名
4. 选择 "Run 'MatchServiceImplTest'" 或 "Run 'testMethodName'"

#### Eclipse
1. 打开项目
2. 右键点击测试文件
3. 选择 "Run As" > "JUnit Test"

### 方法三：使用 Maven Surefire 插件

```bash
# 运行测试并生成报告
mvn surefire:test

# 查看测试报告
# 报告位置：target/surefire-reports/
```

## 测试前准备

### 1. 确保数据库配置正确
- 检查 `application.yml` 中的数据库连接配置
- 确保 MySQL 服务正在运行
- 执行 `sql/create_table.sql` 创建必要的表

### 2. 确保 Redis 配置（可选）
- 如果测试涉及缓存功能，确保 Redis 服务运行
- 或者在测试配置中禁用 Redis

### 3. 检查依赖
```bash
# 确保所有依赖已安装
mvn clean install
```

## 测试类详细说明

### MatchServiceImplTest
**测试内容：**
- 批量匹配用户功能
- 配置值获取
- 缓存操作
- 异常处理

**主要测试方法：**
- `testBatchMatchUsers_Success()` - 正常匹配流程
- `testBatchMatchUsers_FromCache()` - 缓存命中测试
- `testBatchMatchUsers_NullRequest()` - 空请求异常测试
- `testGetConfigValue()` - 配置获取测试

### UserControllerMatchTest
**测试内容：**
- REST API 接口测试
- 请求参数验证
- 响应格式验证
- 权限控制

### MatchServicePerformanceTest
**测试内容：**
- 性能基准测试
- 不同数据量下的性能表现
- 缓存性能测试
- 并发处理能力

## 常见问题解决

### Q1: 测试失败 - 数据库连接错误
**解决方案：**
1. 检查 MySQL 服务是否启动
2. 验证 `application.yml` 中的数据库配置
3. 确保数据库 `valuesfriends` 存在
4. 执行建表脚本

### Q2: 测试失败 - Bean 创建异常
**解决方案：**
1. 确保所有依赖的 Bean 都已正确配置
2. 检查 `@MockBean` 和 `@Mock` 注解使用是否正确
3. 验证测试类的包结构是否正确

### Q3: 性能测试运行时间过长
**解决方案：**
1. 可以调整性能测试中的数据量参数
2. 使用 `@Disabled` 注解暂时禁用性能测试
3. 单独运行性能测试，不与其他测试混合

### Q4: Mock 对象行为不符合预期
**解决方案：**
1. 检查 `when().thenReturn()` 的参数匹配
2. 使用 `ArgumentMatchers` 进行灵活匹配
3. 验证 Mock 对象的方法调用次数和参数

## 测试报告

测试完成后，可以在以下位置查看详细报告：
- **Surefire 报告**: `target/surefire-reports/`
- **JaCoCo 覆盖率报告**: `target/site/jacoco/`

## 持续集成

在 CI/CD 流水线中运行测试：
```yaml
# GitHub Actions 示例
- name: Run tests
  run: mvn test

- name: Generate test report
  run: mvn surefire-report:report
```

## 注意事项

1. **测试隔离**: 每个测试方法应该独立，不依赖其他测试的执行结果
2. **数据清理**: 集成测试后应清理测试数据，避免影响其他测试
3. **性能测试**: 性能测试应在稳定的环境中运行，避免其他进程干扰
4. **Mock 使用**: 单元测试应尽量使用 Mock 对象，减少外部依赖

运行测试前，请确保已按照《数据库初始化指南.md》完成环境配置。